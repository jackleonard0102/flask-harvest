{% extends "base.html" %} {% block content %}
<div class="container">
  <h2>Trucks</h2>
  <div class="d-flex justify-content-between align-items-center my-3">
    <input
      type="text"
      class="form-control w-50"
      id="searchBox"
      placeholder="Search trucks..."
    />
  </div>

  <table class="table">
    <thead class="thead-dark">
      <tr>
        <th class="text-center">No</th>
        <th class="text-center">Name</th>
        <th class="text-center">Year</th>
        <th class="text-center">Vin</th>
        <th class="text-center">Driver</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody id="truckTableBody">
      {% for truck in children_1 %}
      <tr data-truck-id="{{ truck.id }}">
        <td class="text-center align-middle">{{ loop.index }}</td>
        <td class="text-center align-middle">{{ truck.name }}</td>
        <td class="text-center align-middle">{{ truck.year }}</td>
        <td class="text-center align-middle">{{ truck.vin }}</td>
        <td class="text-center align-middle driver-cell">
          {{ truck.current_driver_id and current_user.username or '' }}
        </td>
        <td class="text-center align-middle">
          <form
            method="POST"
            action="{{ url_for('trucker_bp.select_truck_ajax') }}"
            class="select-truck-form"
          >
            <input type="hidden" name="truck_id" value="{{ truck.id }}" />
            <button
              type="submit"
              class="btn {% if truck.current_driver_id == current_user.id %}btn-danger{% else %}btn-primary{% endif %} select-truck-button"
              {%
              if
              truck.current_driver_id
              and
              truck.current_driver_id
              !="current_user.id"
              %}disabled{%
              endif
              %}
            >
              {% if truck.current_driver_id == current_user.id %} Cancel {% else
              %} Select {% endif %}
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const selectButtons = document.querySelectorAll(".select-truck-form");

    selectButtons.forEach((form) => {
      form.addEventListener("submit", function (event) {
        event.preventDefault();
        const formData = new FormData(form);
        const button = form.querySelector(".select-truck-button");
        const isCancel = button.innerText === "Cancel";

        fetch(form.action, {
          method: "POST",
          body: formData,
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert(data.error);
              return;
            }

            const truckRow = document.querySelector(
              `tr[data-truck-id='${data.truck_id}']`
            );
            const driverCell = truckRow.querySelector(".driver-cell");

            if (isCancel) {
              // Reset buttons if a truck is deselected
              selectButtons.forEach((frm) => {
                const btn = frm.querySelector(".select-truck-button");
                btn.innerText = "Select";
                btn.disabled = false;
              });
              driverCell.innerText = "";
            } else {
              // Disable all buttons and set the clicked button to "Cancel"
              selectButtons.forEach((frm) => {
                const btn = frm.querySelector(".select-truck-button");
                if (btn !== button) {
                  btn.disabled = true;
                } else {
                  btn.innerText = "Cancel";
                  driverCell.innerText = data.current_driver_name;
                }
              });
            }
          });
      });
    });
  });
</script>

{% endblock %}
